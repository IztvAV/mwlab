
# üóÉÔ∏è `mwlab.io.backends`

–ú–æ–¥—É–ª—å `mwlab.io.backends` –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç —É–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –∏ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö —Ñ–æ—Ä–º–∞—Ç–∞ Touchstone —á–µ—Ä–µ–∑ –∞–±—Å—Ç—Ä–∞–∫—Ü–∏—é `StorageBackend`. –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Ä–∞–±–æ—Ç—É –∫–∞–∫ —Å –Ω–∞–±–æ—Ä–∞–º–∏ –æ—Ç–¥–µ–ª—å–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ (`FileBackend`), —Ç–∞–∫ –∏ —Å –º–æ–Ω–æ–ª–∏—Ç–Ω—ã–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–º (`HDF5Backend`).

---

## üîë –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å: `StorageBackend`

–ë–∞–∑–æ–≤—ã–π –∞–±—Å—Ç—Ä–∞–∫—Ç–Ω—ã–π –∫–ª–∞—Å—Å —Å –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–º –∫–æ–Ω—Ç—Ä–∞–∫—Ç–æ–º:

```python
class StorageBackend:
    def __len__(self) -> int: ...
    def read(self, idx: int) -> TouchstoneData: ...
    def append(self, ts: TouchstoneData) -> None: ...
```

---

## üìÅ `FileBackend` ‚Äì –Ω–∞–±–æ—Ä *.sNp‚Äë—Ñ–∞–π–ª–æ–≤

–ü—Ä–æ—Å—Ç–æ–π backend, —Ä–∞–±–æ—Ç–∞—é—â–∏–π —Å –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è–º–∏, —Å–æ–¥–µ—Ä–∂–∞—â–∏–º–∏ Touchstone-—Ñ–∞–π–ª—ã (`*.s2p`, `*.sNp`, ...).

### –ü—Ä–∏–º–µ—Ä:

```python
from mwlab.io.backends import FileBackend

backend = FileBackend(root="FilterData/Filter12")
print(len(backend))         # –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ñ–∞–π–ª–æ–≤
ts = backend.read(0)        # TouchstoneData
```

---

## üì¶ `HDF5Backend` ‚Äì –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç

–ü–æ–∑–≤–æ–ª—è–µ—Ç —Ö—Ä–∞–Ω–∏—Ç—å –≤—Å–µ `TouchstoneData` –≤ –æ–¥–Ω–æ–º `.h5`‚Äë—Ñ–∞–π–ª–µ —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π:

- —Ä–µ–∂–∏–º–æ–≤ —á—Ç–µ–Ω–∏—è –∏ –∑–∞–ø–∏—Å–∏ (`mode='r' | 'a' | 'w'`);
- —Ö—Ä–∞–Ω–µ–Ω–∏—è –∑–∞–ø–∏—Å–µ–π –∫–∞–∫ –ø–æ–¥–≥—Ä—É–ø–ø: `/samples/0`, `/samples/1`, ...;
- –æ–±—â–µ–π –∏–ª–∏ –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ–π —á–∞—Å—Ç–æ—Ç–Ω–æ–π —Å–µ—Ç–∫–∏ (`/common_f`, `/samples/X/f`);
- –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ ‚Äî –≤ `attrs`;
- –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö (`unit`, `s_def`, `z0`, `comments`, ...);
- –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–≥–æ —á—Ç–µ–Ω–∏—è (SWMR);
- –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–≥–æ **—Ä–µ–∂–∏–º–∞ in_memory**, –ø—Ä–µ–≤—Ä–∞—â–∞—é—â–µ–≥–æ HDF5 –≤ –∫—ç—à‚Äëbackend.

---

### –†–µ–∂–∏–º—ã —Ä–∞–±–æ—Ç—ã

- `mode="r"` ‚Äî —Ç–æ–ª—å–∫–æ —á—Ç–µ–Ω–∏–µ; –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç SWMR (–µ—Å–ª–∏ `in_memory=False`);
- `mode="w"` ‚Äî –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π —Ñ–∞–π–ª;
- `mode="a"` ‚Äî –¥–æ–∑–∞–ø–∏—Å—å –≤ –∫–æ–Ω–µ—Ü;
- `in_memory=True` ‚Äî –∑–∞–≥—Ä—É–∂–∞–µ—Ç –≤—Å–µ –∑–∞–ø–∏—Å–∏ –≤ –æ–ø–µ—Ä–∞—Ç–∏–≤–Ω—É—é –ø–∞–º—è—Ç—å –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ (—Ç–æ–ª—å–∫–æ –¥–ª—è —á—Ç–µ–Ω–∏—è).

---

### –ü—Ä–∏–º–µ—Ä –∑–∞–ø–∏—Å–∏:

```python
from mwlab.io.backends import HDF5Backend
from mwlab.io.touchstone import TouchstoneData
import skrf as rf
import numpy as np

with HDF5Backend("train.h5", mode="w") as backend:
    f = rf.Frequency(1, 10, 5, "GHz")
    s = np.zeros((5, 2, 2), dtype=complex)
    net = rf.Network(frequency=f, s=s)
    ts = TouchstoneData(net, params={"w": 1.2, "gap": 0.3})
    backend.append(ts)
```

---

### –ü—Ä–∏–º–µ—Ä —á—Ç–µ–Ω–∏—è:

```python
with HDF5Backend("train.h5", mode="r") as backend:
    ts = backend.read(0)
    print(ts.params)
    print(ts.network)
```

---

### –ü—Ä–∏–º–µ—Ä in-memory —Ä–µ–∂–∏–º–∞:

```python
# –ó–∞–≥—Ä—É–∂–∞–µ—Ç –í–°–ï –∑–∞–ø–∏—Å–∏ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ, –¥–∞–ª–µ–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –∏–∑ RAM
backend = HDF5Backend("train.h5", mode="r", in_memory=True)
print(len(backend))
ts = backend.read(0)
```

---

## üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö –≤ HDF5

```
/samples/0/
    ‚îú‚îÄ‚îÄ s            # (F, P, P) complex64 ‚Äì S‚Äë–º–∞—Ç—Ä–∏—Ü–∞
    ‚îú‚îÄ‚îÄ f            # (F,) float64        ‚Äì –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–∞—è —á–∞—Å—Ç–æ—Ç–Ω–∞—è —Å–µ—Ç–∫–∞ (–æ–ø—Ü.)
    ‚îú‚îÄ‚îÄ unit         # ascii ('Hz', 'GHz', ...)
    ‚îú‚îÄ‚îÄ s_def        # ascii ('S', 'T', ...)
    ‚îú‚îÄ‚îÄ z0           # (P,) float64        ‚Äì –æ–ø–æ—Ä–Ω—ã–µ —Å–æ–ø—Ä–æ—Ç–∏–≤–ª–µ–Ω–∏—è
    ‚îú‚îÄ‚îÄ comments     # bytes               ‚Äì UTF‚Äë8 —Å—Ç—Ä–æ–∫–∏ —á–µ—Ä–µ–∑ 
 (–æ–ø—Ü.)
    ‚îî‚îÄ‚îÄ attrs[...]   # –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã (–≤ –∞—Ç—Ä–∏–±—É—Ç–∞—Ö –≥—Ä—É–ø–ø—ã)
/common_f            # (F,) float64        ‚Äì –æ–±—â–∞—è —á–∞—Å—Ç–æ—Ç–Ω–∞—è —Å–µ—Ç–∫–∞ (–µ—Å–ª–∏ –µ—Å—Ç—å)
```

---

## üß™ –ü–æ–∫—Ä—ã—Ç–∏–µ —Ç–µ—Å—Ç–∞–º–∏

`HDF5Backend` –∏ `FileBackend` —Ç–µ—Å—Ç–∏—Ä—É—é—Ç—Å—è —á–µ—Ä–µ–∑:

- –∑–∞–ø–∏—Å—å –∏ –ø–æ—Å–ª–µ–¥—É—é—â–µ–µ —á—Ç–µ–Ω–∏–µ (`append()` ‚Üí `read()`);
- –ø—Ä–æ–≤–µ—Ä–∫—É —Ç–æ—á–Ω–æ—Å—Ç–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è —Å–µ—Ç–∫–∏ –∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤;
- —Ä–∞–±–æ—Ç—É —Å `TouchstoneDataset`;
- –ø–æ–¥–¥–µ—Ä–∂–∫—É `swmr`‚Äë—Ä–µ–∂–∏–º–∞ –∏ `refresh()`;
- –æ—Ç–¥–µ–ª—å–Ω—ã–µ —Ç–µ—Å—Ç—ã –¥–ª—è `in_memory=True`:
  - –∑–∞–≥—Ä—É–∑–∫–∞ –≤—Å–µ—Ö –∑–∞–ø–∏—Å–µ–π;
  - –∑–∞–ø—Ä–µ—Ç –Ω–∞ `append`;
  - —É—Å–∫–æ—Ä–µ–Ω–Ω–æ–µ —á—Ç–µ–Ω–∏–µ –±–µ–∑ –æ–±—Ä–∞—â–µ–Ω–∏—è –∫ —Ñ–∞–π–ª—É.

---

## üìå –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å TouchstoneDataset

–õ—é–±–æ–π backend –º–æ–∂–Ω–æ –ø–µ—Ä–µ–¥–∞—Ç—å –≤ `TouchstoneDataset`:

```python
from mwlab.datasets.touchstone_dataset import TouchstoneDataset

ds = TouchstoneDataset(HDF5Backend("train.h5", "r"))
```

---

## üß© –†–∞—Å—à–∏—Ä—è–µ–º–æ—Å—Ç—å

–ú–æ–∂–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —Å–≤–æ–π backend, —É–Ω–∞—Å–ª–µ–¥–æ–≤–∞–≤—à–∏—Å—å –æ—Ç `StorageBackend`:

```python
class MyBackend(StorageBackend):
    def __len__(self): ...
    def read(self, idx): ...
    def append(self, ts): ...
```
