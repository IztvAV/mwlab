# üì¶ mwlab.codecs ‚Äî TouchstoneCodec

–ú–æ–¥—É–ª—å `mwlab.codecs.touchstone_codec` –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç `TouchstoneCodec` ‚Äî —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å –¥–∞–Ω–Ω—ã—Ö Touchstone (.sNp) –≤ —Ç–µ–Ω–∑–æ—Ä—ã PyTorch –∏ –æ–±—Ä–∞—Ç–Ω–æ.
–û–Ω –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ –¥–∞–Ω–Ω—ã—Ö –∫ –º–∞—à–∏–Ω–Ω–æ–º—É –æ–±—É—á–µ–Ω–∏—é –∏ –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è —Å–µ—Ç–µ–π –∏–∑ –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–π –º–æ–¥–µ–ª–∏.

---

## üöÄ –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

- –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ `TouchstoneData` ‚Üí `(x_tensor, y_tensor, meta)` –∏ –æ–±—Ä–∞—Ç–Ω–æ;
- –û—Ç–¥–µ–ª—å–Ω–æ–µ –∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ/–¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ X (`encode_x`, `decode_x`) –∏ S (`encode_s`, `decode_s`);
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è Codec –ø–æ `TouchstoneDataset` (`from_dataset`);
- –ì–∏–±–∫–∏–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ —Ä–µ–∑–µ—Ä–≤–Ω–æ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è S‚Äë–º–∞—Ç—Ä–∏—Ü—ã (`backup_mode`);
- –ü–æ–ª–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞ `pickle`‚Äë—Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏–∏ (`dumps()`, `loads()`);
- –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å –ª—é–±—ã–º–∏ PyTorch‚Äë–ø–∞–π–ø–ª–∞–π–Ω–∞–º–∏.
---

## ‚öôÔ∏è –°—Ç—Ä–∞—Ç–µ–≥–∏–∏ `backup_mode`

| –†–µ–∂–∏–º     | –û–ø–∏—Å–∞–Ω–∏–µ                                                        |
|-----------|-----------------------------------------------------------------|
| `none`    | –ù–∏—á–µ–≥–æ –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è, –Ω–µ–ø–æ–∫—Ä—ã—Ç—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã¬†‚Üí¬†`0+0j`          |
| `missing` | –°–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–µ `Sij` –≤ `meta['s_missing']`   |
| `full`    | –°–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤—Å—è `S`‚Äë–º–∞—Ç—Ä–∏—Ü–∞ –≤ `meta['s_backup']`               |

–ü—Ä–∏–º–µ—Ä:
```python
codec = TouchstoneCodec(
    x_keys=["w", "gap"],
    y_channels=["S1_1.real"],
    freq_hz=freq_vec,
    backup_mode="full",
)
```

---

## üõ† –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### 1. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –∏–∑ –¥–∞—Ç–∞—Å–µ—Ç–∞

```python
from mwlab.datasets import TouchstoneDataset
from mwlab.codecs import TouchstoneCodec

ds = TouchstoneDataset("Data/Filter12")
codec = TouchstoneCodec.from_dataset(ds, components=["real", "imag", "gd"])
print(codec)
# TouchstoneCodec(x_keys=2, y_channels=12[gd,imag,real], freq_pts=256, ports=2)
```

### 2. –ö–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ `TouchstoneData`

```python
from mwlab.io import TouchstoneData

ts = TouchstoneData(net, params={"w": 1.0, "gap": 2.0})
x_t, y_t, meta = codec.encode(ts)   # y_t —Å–æ–¥–µ—Ä–∂–∏—Ç real / imag / gd
```

### 3. –û–±—Ä–∞—Ç–Ω–æ–µ –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ

```python
ts_restored = codec.decode(y_pred=y_t, meta=meta)
```

### 4. –ß–∞—Å—Ç–∏—á–Ω–æ–µ –∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ

```python
x_tensor = codec.encode_x({"w": 1.0, "gap": 2.0})

s_tensor, meta_s = codec.encode_s(net)   # —Å–æ–¥–µ—Ä–∂–∏—Ç GD‚Äë–∫–∞–Ω–∞–ª—ã, –µ—Å–ª–∏ –∑–∞–¥–∞–Ω—ã
net_rec = codec.decode_s(s_tensor, meta_s)
```

### 5. –°–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è / –¥–µ—Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è

```python
with open("codec.pkl", "wb") as f:
    f.write(codec.dumps())

with open("codec.pkl", "rb") as f:
    codec2 = TouchstoneCodec.loads(f.read())
```

---

## üìê –§–æ—Ä–º–∞—Ç—ã —Ç–µ–Ω–∑–æ—Ä–æ–≤

| –û–±—ä–µ–∫—Ç         | –§–æ—Ä–º–∞          | –û–ø–∏—Å–∞–Ω–∏–µ                            |
|----------------|----------------|-------------------------------------|
| `x_t`          | `(Dx,)`        | –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–∑ X‚Äë–ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞         |
| `y_t`          | `(C, F)`       | S‚Äë–∫–∞–Ω–∞–ª—ã –≤ —á–∞—Å—Ç–æ—Ç–Ω–æ–π –æ–±–ª–∞—Å—Ç–∏        |
| `meta`         | `dict`         | –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –¥–ª—è —Ä–µ–∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ —Å–µ—Ç–∏   |

---

## üéØ –§–æ—Ä–º–∞—Ç `y_channels`

–ö–∞–∂–¥—ã–π –∫–∞–Ω–∞–ª –æ–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è –∫–∞–∫ `S<i>_<j>.<part>`, –≥–¥–µ:

* `i`, `j` ‚Äî –Ω–æ–º–µ—Ä–∞ –ø–æ—Ä—Ç–æ–≤, –Ω–∞—á–∏–Ω–∞—è —Å `1`;
* `part` ‚Äî –∫–æ–º–ø–æ–Ω–µ–Ω—Ç: `real`, `imag`, `mag`, `db`, `deg`, **`gd`** (group delay).

–ü—Ä–∏–º–µ—Ä—ã:

```python
y_channels = [
    "S1_1.real", "S1_1.imag", "S1_1.gd",   # S11
    "S2_1.db",   "S2_1.deg",               # S21
    "S1_2.mag"                            # S12
]
```

*–ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –º–æ–∂–Ω–æ –º–∏–∫—Å–æ–≤–∞—Ç—å –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω–æ; —Ñ–æ—Ä–º–∞ `y_t` –æ—Å—Ç–∞—ë—Ç—Å—è `(C, F)`.*

---

## üß† –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏

* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ `NaN` –≤ X‚Äë–ø–∞—Ä–∞–º–µ—Ç—Ä–∞—Ö;
* –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ —á–∞—Å—Ç–æ—Ç–Ω–æ–π —Å–µ—Ç–∫–∏ (`force_resample`);
* –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ `unit`, `z0`, `s_def`, `comments`;
* –ì—Ä—É–ø–ø–æ–≤–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ (`gd`) –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç—Å—è –ø—Ä–∏ `decode()` ‚Äî –æ–Ω–∞ –Ω–µ –Ω—É–∂–Ω–∞ –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è `S`;
* –ü–æ–ª–Ω–∞—è –æ–±—Ä–∞—Ç–∏–º–æ—Å—Ç—å –ø—Ä–∏ `backup_mode="full"`.

---

## üß™ –¢–µ—Å—Ç—ã

`pytest`‚Äë–Ω–∞–±–æ—Ä –ø–æ–∫—Ä—ã–≤–∞–µ—Ç:

* –ü—Ä—è–º–æ–π –∏ –æ–±—Ä–∞—Ç–Ω—ã–π –ø—Ä–æ—Ö–æ–¥ (`encode`/`decode`), –≤–∫–ª—é—á–∞—è `gd`;
* –í—Å–µ —Ä–µ–∂–∏–º—ã `backup_mode`;
* encode_x / decode_x / encode_s / decode_s;
* –ü—Ä–æ–≤–µ—Ä–∫—É —á–∞—Å—Ç–æ—Ç–Ω–æ–π —Å–µ—Ç–∫–∏ –∏ —Ä–µ—Å—ç–º–ø–ª–∏–Ω–≥–∞;
* –°–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—é / –¥–µ—Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—é (`dumps`, `loads`);
* –ö–æ—Ä—Ä–µ–∫—Ç–Ω—É—é –æ–±—Ä–∞–±–æ—Ç–∫—É `z0`, `unit`, `comments`, `params`.
